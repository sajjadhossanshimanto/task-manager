<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-color: #121212;
      --text-color: #ffffff;
      --card-color: #1e1e1e;
      --accent-color: #00bfa5;
      --completed-color: #555;
      --danger-color: #ff5252;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    .container-box {
      display: flex;
      gap: 2rem;
      width: 100%;
      max-width: 1000px;
      margin-top: 1rem;
    }
    .task-column {
      flex: 2;
    }
    .category-column {
      flex: 1;
    }
    h1 {
      text-align: center;
      color: var(--accent-color);
    }
    #currentTime {
      font-size: 1.2rem;
      color: #ccc;
      margin-bottom: 1rem;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: var(--card-color);
      margin: 10px 0;
      padding: 6px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: grab;
      height: 42px;
    }
    li.completed {
      text-decoration: line-through;
      background: var(--completed-color);
      color: #aaa;
    }
    .delete-btn {
      background: none;
      color: var(--danger-color);
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      margin-left: 10px;
    }
    .task-text {
      flex-grow: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
    }
    .task-name {
      font-weight: bold;
      font-size: 1em;
    }
    .task-time {
      font-size: 0.85em;
      color: #ccc;
      text-align: right;
      white-space: nowrap;
      min-width: 170px;
    }
    .form-inline {
      background: var(--card-color);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      margin-top: 1rem;
    }
    .form-inline input,
    .form-inline select {
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
    }
    .category-list {
      background: var(--card-color);
      padding: 15px;
      border-radius: 10px;
    }
    .category-tag {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .category-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .color-swatch {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #fff;
      cursor: pointer;
    }
    .color-swatch.selected {
      outline: 2px solid var(--accent-color);
    }

  </style>
</head>
<body>
  <h1>Task Manager</h1>
  <div id="currentTime"></div>

  <div class="container-box">
    <div class="task-column">
      <form class="form-inline row g-2" onsubmit="handleTaskForm(event)">
        <div class="col-md-5">
          <input type="text" id="taskName" class="form-control" placeholder="Task Name" required />
        </div>
        <div class="col-md-3">
          <input type="number" id="taskDuration" class="form-control" placeholder="Duration (min)" required />
        </div>
        <div class="col-md-3">
          <div class="input-group">
            <select id="taskCategory" class="form-select"></select>
          </div>
        </div>
        <div class="col-md-1">
          <button class="btn btn-success w-100">➕</button>
        </div>
      </form>

      <ul id="taskList"></ul>
    </div>

    <div class="category-column">
      <div id="timerSection" style="margin-bottom: 18px;">
        <div class="card p-3 bg-dark text-white" style="min-width: 200px; box-shadow: 0 2px 8px #0008; border-radius: 14px;">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span style="font-weight: bold; font-size: 1.1em; letter-spacing: 1px;">⏱ Countdown Timer</span>
          </div>
          <div class="text-center mb-2">
            <span id="timerDisplay" style="font-size:2.1em; font-variant-numeric: tabular-nums; font-weight: 600; letter-spacing: 2px; cursor:pointer; user-select:none;">00:00:00</span>
          </div>
          <div class="d-flex justify-content-center gap-2" id="timerBtnGroup">
            <button id="timerStart" class="btn btn-success btn-circle" title="Start" style="border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;"><svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><polygon points='5 3 19 12 5 21 5 3'/></svg></button>
          </div>
          <form id="timerSetForm" class="mt-2" style="display:none;">
            <div class="d-flex gap-1 align-items-center justify-content-center">
              <input id="timerHrs" type="number" min="0" max="23" class="form-control form-control-sm bg-dark text-white" style="width:40px;" placeholder="hh">
              <span>:</span>
              <input id="timerMins" type="number" min="0" max="59" class="form-control form-control-sm bg-dark text-white" style="width:40px;" placeholder="mm">
              <span>:</span>
              <input id="timerSecs" type="number" min="0" max="59" class="form-control form-control-sm bg-dark text-white" style="width:40px;" placeholder="ss">
            </div>
          </form>
          <audio id="timerEndSound" src="sound-effect-old-phone.mp3" preload="auto"></audio>
        </div>
      </div>
      <div class="category-list" id="categoryList"></div>
      <hr class="text-secondary" />
      <form id="categoryForm" class="mt-3">
        <div class="mb-2">
          <input type="text" id="newCategoryName" class="form-control" placeholder="New Category Name" required>
        </div>
        <div class="mb-2">
          <label class="form-label d-block mb-1">Choose Color:</label>
          <div id="colorPalette" class="d-flex flex-wrap gap-2">
            <!-- Color options rendered by JS -->
          </div>
          <input type="color" id="customColor" class="form-control form-control-color mt-2" title="Pick a custom color">
        </div>
        <button type="submit" class="btn btn-outline-light w-100">Create Category</button>
      </form>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    let taskList = JSON.parse(localStorage.getItem("taskList")) || [];
    let categories = JSON.parse(localStorage.getItem("categories")) || [
      { name: "General", color: "#00bfa5" }
    ];

    function saveTasks() {
      localStorage.setItem("taskList", JSON.stringify(taskList));
    }
    function saveCategories() {
      localStorage.setItem("categories", JSON.stringify(categories));
    }

    function updateCurrentTime() {
      const now = new Date();
      document.getElementById("currentTime").innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      renderTasks();
    }

    function renderTasks() {
      const ul = document.getElementById("taskList");
      ul.innerHTML = "";
      let startTime = new Date();

      taskList.forEach((task, index) => {
        const li = document.createElement("li");
        li.className = task.completed ? "completed" : "";
        const cat = categories.find(c => c.name === task.category);
        if (cat) li.style.borderLeft = `8px solid ${cat.color}`;

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = task.completed;
        checkbox.onchange = () => {
          task.completed = checkbox.checked;
          saveTasks();
          renderTasks();
        };

        const textSpan = document.createElement("span");
        textSpan.className = "task-text";

        const nameSpan = document.createElement("span");
        nameSpan.className = "task-name";
        nameSpan.textContent = task.name;
        // Enable editing task name on double click
        nameSpan.ondblclick = () => {
          if (task.completed) return;
          const input = document.createElement("input");
          input.type = "text";
          input.value = task.name;
          input.style.width = Math.max(80, task.name.length * 10) + "px";
          input.style.fontSize = "1em";
          nameSpan.textContent = "";
          nameSpan.appendChild(input);
          input.focus();
          input.addEventListener("blur", () => {
            const newName = input.value.trim();
            if (newName) {
              task.name = newName;
              saveTasks();
              renderTasks();
            } else {
              renderTasks();
            }
          });
          input.addEventListener("keydown", e => {
            if (e.key === "Enter") input.blur();
            if (e.key === "Escape") renderTasks();
          });
        };

        const timeSpan = document.createElement("span");
        timeSpan.className = "task-time";

        const endTime = new Date(startTime.getTime() + task.duration * 60000);
        const hrs = Math.floor(task.duration / 60);
        const mins = task.duration % 60;
        const durationStr = `${hrs > 0 ? hrs + 'h ' : ''}${mins}m`;
        if (!task.completed) {
          timeSpan.textContent = `${durationStr} — Ends: ${endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
          startTime = endTime;
        } else {
          timeSpan.textContent = `${durationStr}`;
        }

        timeSpan.ondblclick = () => {
          if (task.completed) return;
          const input = document.createElement("input");
          input.type = "number";
          input.min = "1";
          input.value = task.duration;
          input.style.width = "60px";
          input.style.fontSize = "0.85em";
          timeSpan.textContent = "";
          timeSpan.appendChild(input);
          input.focus();
          input.addEventListener("blur", () => {
            const newDuration = parseInt(input.value);
            if (!isNaN(newDuration) && newDuration > 0) {
              task.duration = newDuration;
              saveTasks();
              renderTasks();
            } else {
              renderTasks();
            }
          });
          input.addEventListener("keydown", e => {
            if (e.key === "Enter") input.blur();
            if (e.key === "Escape") renderTasks();
          });
        };

        textSpan.appendChild(nameSpan);
        textSpan.appendChild(timeSpan);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = "🗑️";
        deleteBtn.onclick = () => {
          taskList.splice(index, 1);
          saveTasks();
          renderTasks();
        };

        li.appendChild(checkbox);
        li.appendChild(textSpan);
        li.appendChild(deleteBtn);
        ul.appendChild(li);
      });
    }

    function updateCategoryDropdown() {
      // Update sidebar list
      const list = document.getElementById("categoryList");
      list.innerHTML = categories.map((cat, idx) => `
        <div class="category-tag d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <div class="category-color" style="background:${cat.color}"></div>
            <span>${cat.name}</span>
          </div>
          ${cat.name !== "General" ? `<button class="btn btn-sm btn-outline-danger ms-2 py-0 px-2" onclick="deleteCategory(${idx})">🗑️</button>` : ""}
        </div>
      `).join("");

      // ✅ Update dropdown list
      const dropdown = document.getElementById("taskCategory");
      dropdown.innerHTML = categories.map(cat => `
        <option value="${cat.name}">${cat.name}</option>
      `).join("");
    }

    function handleTaskForm(e) {
      e.preventDefault();
      const name = document.getElementById('taskName').value;
      const duration = parseInt(document.getElementById('taskDuration').value);
      const category = document.getElementById('taskCategory').value;
      if (!name || isNaN(duration) || duration <= 0) {
        alert("Invalid input");
        return;
      }
      taskList.push({ name, duration, completed: false, category });
      saveTasks();
      renderTasks();
      e.target.reset();
    }


    new Sortable(document.getElementById('taskList'), {
      animation: 150,
      onEnd: function(evt) {
        const movedItem = taskList.splice(evt.oldIndex, 1)[0];
        taskList.splice(evt.newIndex, 0, movedItem);
        saveTasks();
        renderTasks();
      }
    });

    const paletteColors = ["#00bfa5", "#e91e63", "#ffc107", "#3f51b5", "#8bc34a", "#ff5722", "#9c27b0"];
    let selectedColor = paletteColors[0];

    function renderColorPalette() {
      const container = document.getElementById("colorPalette");
      container.innerHTML = "";
      paletteColors.forEach(color => {
        const swatch = document.createElement("div");
        swatch.className = "color-swatch";
        swatch.style.backgroundColor = color;
        if (color === selectedColor) swatch.classList.add("selected");
        swatch.onclick = () => {
          selectedColor = color;
          renderColorPalette();
        };
        container.appendChild(swatch);
      });

      const custom = document.getElementById("customColor");
      custom.value = selectedColor;
      custom.onchange = () => {
        selectedColor = custom.value;
        renderColorPalette();
      };
    }

    document.getElementById("categoryForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const nameInput = document.getElementById("newCategoryName");
      const name = nameInput.value.trim();
      if (!name) return;

      if (categories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
        alert("Category already exists!");
        return;
      }

      categories.push({ name, color: selectedColor });
      saveCategories();
      updateCategoryDropdown();
      nameInput.value = "";
    });
    function deleteCategory(index) {
      const catToDelete = categories[index].name;

      const used = taskList.some(task => task.category === catToDelete);
      if (used) {
        alert("This category is used in tasks. Please reassign or delete those tasks first.");
        return;
      }

      if (!confirm(`Are you sure you want to delete category "${catToDelete}"?`)) return;

      categories.splice(index, 1);
      saveCategories();
      updateCategoryDropdown();
    }


    // Countdown Timer Logic
    let timerInterval = null;
    let timerTotalSeconds = 0;
    let timerSecondsLeft = 0;
    let timerState = 'idle'; // idle, running, paused
    let timerEndTimestamp = null;

    function updateTimerDisplay() {
      const hrs = String(Math.floor(timerSecondsLeft / 3600)).padStart(2, '0');
      const mins = String(Math.floor((timerSecondsLeft % 3600) / 60)).padStart(2, '0');
      const secs = String(timerSecondsLeft % 60).padStart(2, '0');
      const display = document.getElementById('timerDisplay');
      display.innerHTML = `<span class='timer-part' data-part='hrs'>${hrs}</span>:<span class='timer-part' data-part='mins'>${mins}</span>:<span class='timer-part' data-part='secs'>${secs}</span>`;
      // Update document title if running
      if (timerState === 'running') {
        document.title = `${hrs}:${mins}:${secs} - Task Manager`;
      } else {
        document.title = 'Task Manager';
      }
    }

    function setTimerBtns() {
      const btnGroup = document.getElementById('timerBtnGroup');
      btnGroup.innerHTML = '';
      if (timerState === 'idle' || timerState === 'paused') {
        // Start button
        const startBtn = document.createElement('button');
        startBtn.id = 'timerStart';
        startBtn.className = 'btn btn-success btn-circle';
        startBtn.title = 'Start';
        startBtn.style = 'border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;';
        startBtn.innerHTML = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><polygon points='5 3 19 12 5 21 5 3'/></svg>";
        startBtn.onclick = startTimer;
        btnGroup.appendChild(startBtn);
      }
      if (timerState === 'running') {
        // Pause button
        const pauseBtn = document.createElement('button');
        pauseBtn.id = 'timerPause';
        pauseBtn.className = 'btn btn-warning btn-circle';
        pauseBtn.title = 'Pause';
        pauseBtn.style = 'border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;';
        pauseBtn.innerHTML = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='6' y='4' width='4' height='16'/><rect x='14' y='4' width='4' height='16'/></svg>";
        pauseBtn.onclick = pauseTimer;
        btnGroup.appendChild(pauseBtn);
        // Reset button
        const resetBtn = document.createElement('button');
        resetBtn.id = 'timerReset';
        resetBtn.className = 'btn btn-danger btn-circle';
        resetBtn.title = 'Reset';
        resetBtn.style = 'border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;';
        resetBtn.innerHTML = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M1 4v6h6'/><path d='M3.51 15a9 9 0 1 0 2.13-9.36L1 10'/></svg>";
        resetBtn.onclick = resetTimer;
        btnGroup.appendChild(resetBtn);
      }
      if (timerState === 'paused') {
        // Reset button
        const resetBtn = document.createElement('button');
        resetBtn.id = 'timerReset';
        resetBtn.className = 'btn btn-danger btn-circle';
        resetBtn.title = 'Reset';
        resetBtn.style = 'border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;';
        resetBtn.innerHTML = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M1 4v6h6'/><path d='M3.51 15a9 9 0 1 0 2.13-9.36L1 10'/></svg>";
        resetBtn.onclick = resetTimer;
        btnGroup.appendChild(resetBtn);
      }
    }

    function startTimer() {
      if (timerSecondsLeft <= 0) return;
      timerState = 'running';
      setTimerBtns();
      timerEndTimestamp = Date.now() + timerSecondsLeft * 1000;
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const now = Date.now();
        timerSecondsLeft = Math.max(0, Math.round((timerEndTimestamp - now) / 1000));
        updateTimerDisplay();
        if (timerSecondsLeft <= 0) {
          clearInterval(timerInterval);
          timerState = 'idle';
          setTimerBtns();
          document.getElementById('timerEndSound').play();
        }
      }, 250);
    }
    function pauseTimer() {
      timerState = 'paused';
      clearInterval(timerInterval);
      timerEndTimestamp = null;
      setTimerBtns();
    }
    function resetTimer() {
      timerState = 'idle';
      clearInterval(timerInterval);
      timerSecondsLeft = timerTotalSeconds;
      timerEndTimestamp = null;
      updateTimerDisplay();
      setTimerBtns();
    }

    // Double click to set timer part
    document.addEventListener('DOMContentLoaded', () => {
      updateTimerDisplay();
      setTimerBtns();
      const timerDisplay = document.getElementById('timerDisplay');
      timerDisplay.addEventListener('dblclick', function(e) {
        if (!e.target.classList.contains('timer-part')) return;
        const part = e.target.getAttribute('data-part');
        const current = e.target.textContent;
        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.max = part === 'hrs' ? '23' : '59';
        input.value = parseInt(current, 10);
        input.style.textAlign = 'center';
        input.style.background = '#222';
        input.style.color = '#fff';
        input.style.border = '1px solid #555';
        input.style.borderRadius = '6px';
        e.target.replaceWith(input);
        input.focus();
        input.select();
        input.addEventListener('blur', finishEdit);
        input.addEventListener('keydown', function(ev) {
          if (ev.key === 'Enter') input.blur();
          if (ev.key === 'Escape') finishEdit();
        });
        function finishEdit() {
          let val = parseInt(input.value, 10);
          if (isNaN(val) || val < 0) val = 0;
          if (part === 'hrs') val = Math.min(val, 23);
          else val = Math.min(val, 59);
          let hrs = Math.floor(timerSecondsLeft / 3600);
          let mins = Math.floor((timerSecondsLeft % 3600) / 60);
          let secs = timerSecondsLeft % 60;
          if (part === 'hrs') hrs = val;
          if (part === 'mins') mins = val;
          if (part === 'secs') secs = val;
          timerTotalSeconds = hrs * 3600 + mins * 60 + secs;
          timerSecondsLeft = timerTotalSeconds;
          updateTimerDisplay();
          setTimerBtns();
        }
      });
    });


    renderColorPalette();


    updateCurrentTime();
    setInterval(updateCurrentTime, 60000);
    updateCategoryDropdown();
  </script>
</body>
</html>
