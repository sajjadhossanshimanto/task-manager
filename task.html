<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-color: #121212;
      --text-color: #ffffff;
      --card-color: #1e1e1e;
      --accent-color: #00bfa5;
      --completed-color: #555;
      --danger-color: #ff5252;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    .container-box {
      display: flex;
      gap: 2rem;
      width: 100%;
      max-width: 1000px;
      margin-top: 1rem;
    }
    .task-column {
      flex: 2;
    }
    .category-column {
      flex: 1;
    }
    h1 {
      text-align: center;
      color: var(--accent-color);
    }
    #currentTime {
      font-size: 1.2rem;
      color: #ccc;
      margin-bottom: 1rem;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: var(--card-color);
      margin: 10px 0;
      padding: 6px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: grab;
      height: 42px;
    }
    li.completed {
      text-decoration: line-through;
      background: var(--completed-color);
      color: #aaa;
    }
    .delete-btn {
      background: none;
      color: var(--danger-color);
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      margin-left: 10px;
    }
    .task-text {
      flex-grow: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
    }
    .task-name {
      font-weight: bold;
      font-size: 1em;
    }
    .task-time {
      font-size: 0.85em;
      color: #ccc;
      text-align: right;
      white-space: nowrap;
      min-width: 170px;
    }
    .form-inline {
      background: var(--card-color);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      margin-top: 1rem;
    }
    .form-inline input,
    .form-inline select {
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
    }
    .category-list {
      background: var(--card-color);
      padding: 15px;
      border-radius: 10px;
    }
    .category-tag {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .category-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .color-swatch {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #fff;
      cursor: pointer;
    }
    .color-swatch.selected {
      outline: 2px solid var(--accent-color);
    }

  </style>
</head>
<body>
  <h1>Task Manager</h1>
  <div id="currentTime"></div>

  <div class="container-box">
    <div class="task-column">
      <form class="form-inline row g-2" onsubmit="handleTaskForm(event)">
        <div class="col-md-5">
          <input type="text" id="taskName" class="form-control" placeholder="Task Name" required />
        </div>
        <div class="col-md-3">
          <input type="number" id="taskDuration" class="form-control" placeholder="Duration (min)" required />
        </div>
        <div class="col-md-3">
          <div class="input-group">
            <select id="taskCategory" class="form-select"></select>
          </div>
        </div>
        <div class="col-md-1">
          <button class="btn btn-success w-100">➕</button>
        </div>
      </form>

      <ul id="taskList"></ul>
    </div>

    <div class="category-column">
      <div id="timerSection" style="margin-bottom: 18px;">
        <div class="card p-3 bg-dark text-white" style="min-width: 200px; box-shadow: 0 2px 8px #0008; border-radius: 14px;">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span style="font-weight: bold; font-size: 1.1em; letter-spacing: 1px;">⏱ Countdown Timers</span>
            <span id="timerNavInfo" style="font-size:0.95em;color:#aaa;"></span>
          </div>
          <div class="d-flex align-items-center justify-content-center mb-2" style="gap:8px;">
            <button id="timerPrev" class="btn btn-outline-light btn-sm" style="border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" title="Previous Timer">&#8592;</button>
            <span id="timerDisplay" style="font-size:2.1em; font-variant-numeric: tabular-nums; font-weight: 600; letter-spacing: 2px; cursor:pointer; user-select:none;min-width:140px;display:inline-block;"></span>
            <button id="timerNext" class="btn btn-outline-light btn-sm" style="border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" title="Next Timer">&#8594;</button>
          </div>
          <div class="d-flex justify-content-center gap-2 mb-2" id="timerBtnGroup"></div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <button id="addTimerBtn" class="btn btn-success btn-sm" title="Add Timer" style="border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">+</button>
            <button id="removeTimerBtn" class="btn btn-danger btn-sm" title="Remove Timer" style="border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">&#128465;</button>
          </div>
          <audio id="timerEndSound" src="sound-effect-old-phone.mp3" preload="auto"></audio>
        </div>
      </div>
      <div class="category-list" id="categoryList"></div>
      <hr class="text-secondary" />
      <form id="categoryForm" class="mt-3">
        <div class="mb-2">
          <input type="text" id="newCategoryName" class="form-control" placeholder="New Category Name" required>
        </div>
        <div class="mb-2">
          <label class="form-label d-block mb-1">Choose Color:</label>
          <div id="colorPalette" class="d-flex flex-wrap gap-2">
            <!-- Color options rendered by JS -->
          </div>
          <input type="color" id="customColor" class="form-control form-control-color mt-2" title="Pick a custom color">
        </div>
        <button type="submit" class="btn btn-outline-light w-100">Create Category</button>
      </form>

      <!-- Calendar View -->
      <div id="calendarContainer" class="mt-4 p-3" style="background: var(--card-color); border-radius: 10px; box-shadow: 0 2px 8px #0004;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <button id="prevMonth" class="btn btn-sm btn-outline-light px-2 py-0">&#8592;</button>
          <span id="calendarMonth" style="font-weight: 500;"></span>
          <button id="nextMonth" class="btn btn-sm btn-outline-light px-2 py-0">&#8594;</button>
        </div>
        <table class="table table-sm table-dark mb-0" style="border-radius:8px;overflow:hidden;">
          <thead>
            <tr id="calendarDays"></tr>
          </thead>
          <tbody id="calendarDates"></tbody>
        </table>
      </div>
      <!-- End Calendar View -->

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    let taskList = JSON.parse(localStorage.getItem("taskList")) || [];
    let categories = JSON.parse(localStorage.getItem("categories")) || [
      { name: "General", color: "#00bfa5" }
    ];

    function saveTasks() {
      localStorage.setItem("taskList", JSON.stringify(taskList));
    }
    function saveCategories() {
      localStorage.setItem("categories", JSON.stringify(categories));
    }

    function updateCurrentTime() {
      const now = new Date();
      document.getElementById("currentTime").innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      renderTasks();
    }

    function renderTasks() {
      const ul = document.getElementById("taskList");
      ul.innerHTML = "";
      let startTime = new Date();

      taskList.forEach((task, index) => {
        const li = document.createElement("li");
        li.className = task.completed ? "completed" : "";
        const cat = categories.find(c => c.name === task.category);
        if (cat) li.style.borderLeft = `8px solid ${cat.color}`;

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = task.completed;
        checkbox.onchange = () => {
          task.completed = checkbox.checked;
          saveTasks();
          renderTasks();
        };

        const textSpan = document.createElement("span");
        textSpan.className = "task-text";

        const nameSpan = document.createElement("span");
        nameSpan.className = "task-name";
        nameSpan.textContent = task.name;
        // Enable editing task name on double click
        nameSpan.ondblclick = () => {
          if (task.completed) return;
          const input = document.createElement("input");
          input.type = "text";
          input.value = task.name;
          input.style.width = Math.max(80, task.name.length * 10) + "px";
          input.style.fontSize = "1em";
          nameSpan.textContent = "";
          nameSpan.appendChild(input);
          input.focus();
          input.addEventListener("blur", () => {
            const newName = input.value.trim();
            if (newName) {
              task.name = newName;
              saveTasks();
              renderTasks();
            } else {
              renderTasks();
            }
          });
          input.addEventListener("keydown", e => {
            if (e.key === "Enter") input.blur();
            if (e.key === "Escape") renderTasks();
          });
        };

        const timeSpan = document.createElement("span");
        timeSpan.className = "task-time";

        const endTime = new Date(startTime.getTime() + task.duration * 60000);
        const hrs = Math.floor(task.duration / 60);
        const mins = task.duration % 60;
        const durationStr = `${hrs > 0 ? hrs + 'h ' : ''}${mins}m`;
        if (!task.completed) {
          timeSpan.textContent = `${durationStr} — Ends: ${endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
          startTime = endTime;
        } else {
          timeSpan.textContent = `${durationStr}`;
        }

        timeSpan.ondblclick = () => {
          if (task.completed) return;
          const input = document.createElement("input");
          input.type = "number";
          input.min = "1";
          input.value = task.duration;
          input.style.width = "60px";
          input.style.fontSize = "0.85em";
          timeSpan.textContent = "";
          timeSpan.appendChild(input);
          input.focus();
          input.addEventListener("blur", () => {
            const newDuration = parseInt(input.value);
            if (!isNaN(newDuration) && newDuration > 0) {
              task.duration = newDuration;
              saveTasks();
              renderTasks();
            } else {
              renderTasks();
            }
          });
          input.addEventListener("keydown", e => {
            if (e.key === "Enter") input.blur();
            if (e.key === "Escape") renderTasks();
          });
        };

        textSpan.appendChild(nameSpan);
        textSpan.appendChild(timeSpan);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = "🗑️";
        deleteBtn.onclick = () => {
          taskList.splice(index, 1);
          saveTasks();
          renderTasks();
        };

        li.appendChild(checkbox);
        li.appendChild(textSpan);
        li.appendChild(deleteBtn);
        ul.appendChild(li);
      });
    }

    function updateCategoryDropdown() {
      // Update sidebar list
      const list = document.getElementById("categoryList");
      list.innerHTML = categories.map((cat, idx) => `
        <div class="category-tag d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <div class="category-color" style="background:${cat.color}"></div>
            <span>${cat.name}</span>
          </div>
          ${cat.name !== "General" ? `<button class="btn btn-sm btn-outline-danger ms-2 py-0 px-2" onclick="deleteCategory(${idx})">🗑️</button>` : ""}
        </div>
      `).join("");

      // ✅ Update dropdown list
      const dropdown = document.getElementById("taskCategory");
      dropdown.innerHTML = categories.map(cat => `
        <option value="${cat.name}">${cat.name}</option>
      `).join("");
    }

    function handleTaskForm(e) {
      e.preventDefault();
      const name = document.getElementById('taskName').value;
      const duration = parseInt(document.getElementById('taskDuration').value);
      const category = document.getElementById('taskCategory').value;
      if (!name || isNaN(duration) || duration <= 0) {
        alert("Invalid input");
        return;
      }
      taskList.push({ name, duration, completed: false, category });
      saveTasks();
      renderTasks();
      e.target.reset();
    }


    new Sortable(document.getElementById('taskList'), {
      animation: 150,
      onEnd: function(evt) {
        const movedItem = taskList.splice(evt.oldIndex, 1)[0];
        taskList.splice(evt.newIndex, 0, movedItem);
        saveTasks();
        renderTasks();
      }
    });

    const paletteColors = ["#00bfa5", "#e91e63", "#ffc107", "#3f51b5", "#8bc34a", "#ff5722", "#9c27b0"];
    let selectedColor = paletteColors[0];

    function renderColorPalette() {
      const container = document.getElementById("colorPalette");
      container.innerHTML = "";
      paletteColors.forEach(color => {
        const swatch = document.createElement("div");
        swatch.className = "color-swatch";
        swatch.style.backgroundColor = color;
        if (color === selectedColor) swatch.classList.add("selected");
        swatch.onclick = () => {
          selectedColor = color;
          renderColorPalette();
        };
        container.appendChild(swatch);
      });

      const custom = document.getElementById("customColor");
      custom.value = selectedColor;
      custom.onchange = () => {
        selectedColor = custom.value;
        renderColorPalette();
      };
    }

    document.getElementById("categoryForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const nameInput = document.getElementById("newCategoryName");
      const name = nameInput.value.trim();
      if (!name) return;

      if (categories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
        alert("Category already exists!");
        return;
      }

      categories.push({ name, color: selectedColor });
      saveCategories();
      updateCategoryDropdown();
      nameInput.value = "";
    });
    function deleteCategory(index) {
      const catToDelete = categories[index].name;

      const used = taskList.some(task => task.category === catToDelete);
      if (used) {
        alert("This category is used in tasks. Please reassign or delete those tasks first.");
        return;
      }

      if (!confirm(`Are you sure you want to delete category "${catToDelete}"?`)) return;

      categories.splice(index, 1);
      saveCategories();
      updateCategoryDropdown();
    }


    // --- Multi-Timer Logic ---
    let timers = JSON.parse(localStorage.getItem('timers')) || [
      { total: 0, left: 0, state: 'idle' }
    ];
    let activeTimerIdx = 0;
    let timerInterval = null;
    function saveTimers() {
      localStorage.setItem('timers', JSON.stringify(timers));
    }
    function updateTimerNavInfo() {
      document.getElementById('timerNavInfo').textContent = `Timer ${activeTimerIdx+1} / ${timers.length}`;
    }
    function updateTimerDisplay() {
      const t = timers[activeTimerIdx];
      const left = t.left;
      const hrs = String(Math.floor(left / 3600)).padStart(2, '0');
      const mins = String(Math.floor((left % 3600) / 60)).padStart(2, '0');
      const secs = String(left % 60).padStart(2, '0');
      const display = document.getElementById('timerDisplay');
      display.innerHTML = `<span class='timer-part' data-part='hrs'>${hrs}</span>:<span class='timer-part' data-part='mins'>${mins}</span>:<span class='timer-part' data-part='secs'>${secs}</span>`;
      if (t.state === 'running') {
        document.title = `${hrs}:${mins}:${secs} - Task Manager`;
      } else {
        document.title = 'Task Manager';
      }
      updateTimerNavInfo();
    }
    function setTimerBtns() {
      const btnGroup = document.getElementById('timerBtnGroup');
      btnGroup.innerHTML = '';
      const t = timers[activeTimerIdx];
      if (t.state === 'idle' || t.state === 'paused') {
        // Start button
        const startBtn = document.createElement('button');
        startBtn.className = 'btn btn-success btn-circle';
        startBtn.title = 'Start';
        startBtn.style = 'border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;';
        startBtn.innerHTML = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><polygon points='5 3 19 12 5 21 5 3'/></svg>";
        startBtn.onclick = startTimer;
        btnGroup.appendChild(startBtn);
      }
      if (t.state === 'running') {
        // Pause button
        const pauseBtn = document.createElement('button');
        pauseBtn.className = 'btn btn-warning btn-circle';
        pauseBtn.title = 'Pause';
        pauseBtn.style = 'border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;';
        pauseBtn.innerHTML = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='6' y='4' width='4' height='16'/><rect x='14' y='4' width='4' height='16'/></svg>";
        pauseBtn.onclick = pauseTimer;
        btnGroup.appendChild(pauseBtn);
        // Reset button
        const resetBtn = document.createElement('button');
        resetBtn.className = 'btn btn-danger btn-circle';
        resetBtn.title = 'Reset';
        resetBtn.style = 'border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;';
        resetBtn.innerHTML = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M1 4v6h6'/><path d='M3.51 15a9 9 0 1 0 2.13-9.36L1 10'/></svg>";
        resetBtn.onclick = resetTimer;
        btnGroup.appendChild(resetBtn);
      }
      if (t.state === 'paused') {
        // Reset button
        const resetBtn = document.createElement('button');
        resetBtn.className = 'btn btn-danger btn-circle';
        resetBtn.title = 'Reset';
        resetBtn.style = 'border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;';
        resetBtn.innerHTML = "<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M1 4v6h6'/><path d='M3.51 15a9 9 0 1 0 2.13-9.36L1 10'/></svg>";
        resetBtn.onclick = resetTimer;
        btnGroup.appendChild(resetBtn);
      }
    }
    function startTimer() {
      const t = timers[activeTimerIdx];
      if (t.left <= 0) return;
      t.state = 'running';
      setTimerBtns();
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        t.left = Math.max(0, t.left - 1);
        updateTimerDisplay();
        if (t.left <= 0) {
          clearInterval(timerInterval);
          t.state = 'idle';
          setTimerBtns();
          document.getElementById('timerEndSound').play();
        }
        saveTimers();
      }, 1000);
      saveTimers();
    }
    function pauseTimer() {
      const t = timers[activeTimerIdx];
      t.state = 'paused';
      clearInterval(timerInterval);
      setTimerBtns();
      saveTimers();
    }
    function resetTimer() {
      const t = timers[activeTimerIdx];
      t.state = 'idle';
      clearInterval(timerInterval);
      t.left = t.total;
      updateTimerDisplay();
      setTimerBtns();
      saveTimers();
    }
    function switchTimer(idx) {
      if (idx < 0 || idx >= timers.length) return;
      clearInterval(timerInterval);
      activeTimerIdx = idx;
      updateTimerDisplay();
      setTimerBtns();
      saveTimers();
    }
    function addTimer() {
      timers.push({ total: 0, left: 0, state: 'idle' });
      switchTimer(timers.length - 1);
    }
    function removeTimer() {
      if (timers.length <= 1) return;
      timers.splice(activeTimerIdx, 1);
      if (activeTimerIdx >= timers.length) activeTimerIdx = timers.length - 1;
      switchTimer(activeTimerIdx);
    }
    document.getElementById('timerPrev').onclick = () => {
      switchTimer((activeTimerIdx - 1 + timers.length) % timers.length);
    };
    document.getElementById('timerNext').onclick = () => {
      switchTimer((activeTimerIdx + 1) % timers.length);
    };
    document.getElementById('addTimerBtn').onclick = addTimer;
    document.getElementById('removeTimerBtn').onclick = removeTimer;
    // Double click to set timer part
    document.getElementById('timerDisplay').addEventListener('dblclick', function(e) {
        if (!e.target.classList.contains('timer-part')) return;
        const part = e.target.getAttribute('data-part');
        const current = e.target.textContent;
        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.max = part === 'hrs' ? '23' : '59';
        input.value = parseInt(current, 10);
        input.style.textAlign = 'center';
        input.style.background = '#222';
        input.style.color = '#fff';
        input.style.border = '1px solid #555';
        input.style.borderRadius = '6px';
        e.target.replaceWith(input);
        input.focus();
        input.select();
        input.addEventListener('blur', finishEdit);
        input.addEventListener('keydown', function(ev) {
          if (ev.key === 'Enter') input.blur();
          if (ev.key === 'Escape') finishEdit();
        });
        function finishEdit() {
          let val = parseInt(input.value, 10);
          if (isNaN(val) || val < 0) val = 0;
          if (part === 'hrs') val = Math.min(val, 23);
          else val = Math.min(val, 59);
        let t = timers[activeTimerIdx];
        let hrs = Math.floor(t.left / 3600);
        let mins = Math.floor((t.left % 3600) / 60);
        let secs = t.left % 60;
          if (part === 'hrs') hrs = val;
          if (part === 'mins') mins = val;
          if (part === 'secs') secs = val;
        t.total = hrs * 3600 + mins * 60 + secs;
        t.left = t.total;
        t.state = 'idle';
          updateTimerDisplay();
          setTimerBtns();
        saveTimers();
        }
      });
    // Initial render
    updateTimerDisplay();
    setTimerBtns();
    updateTimerNavInfo();
    renderColorPalette();


    updateCurrentTime();
    setInterval(updateCurrentTime, 60000);
    updateCategoryDropdown();

    // Calendar Logic
    const calendarMonth = document.getElementById('calendarMonth');
    const calendarDays = document.getElementById('calendarDays');
    const calendarDates = document.getElementById('calendarDates');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');

    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    let calDate = new Date();
    calDate.setDate(1);

    function renderCalendar() {
      calendarMonth.textContent = calDate.toLocaleString('default', { month: 'long', year: 'numeric' });
      calendarDays.innerHTML = dayNames.map(d => `<th class='text-center' style='font-size:0.95em;color:#aaa;'>${d}</th>`).join('');
      const year = calDate.getFullYear();
      const month = calDate.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let html = '<tr>';
      for (let i = 0; i < firstDay; i++) html += '<td></td>';
      for (let d = 1; d <= daysInMonth; d++) {
        const today = new Date();
        const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
        html += `<td class='text-center' style='padding:2px;${isToday ? 'background:var(--accent-color);color:#fff;border-radius:6px;' : ''}'>${d}</td>`;
        if ((firstDay + d) % 7 === 0 && d !== daysInMonth) html += '</tr><tr>';
      }
      const lastDay = (firstDay + daysInMonth) % 7;
      for (let i = lastDay; i > 0 && i < 7; i++) html += '<td></td>';
      html += '</tr>';
      calendarDates.innerHTML = html;
    }
    prevMonthBtn.onclick = () => {
      calDate.setMonth(calDate.getMonth() - 1);
      renderCalendar();
    };
    nextMonthBtn.onclick = () => {
      calDate.setMonth(calDate.getMonth() + 1);
      renderCalendar();
    };
    renderCalendar();
  </script>
</body>
</html>
